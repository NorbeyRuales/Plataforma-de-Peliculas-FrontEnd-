<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pages/movie/MovieDetail.tsx - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Pages_Account.html">Pages/Account</a><ul class='methods'><li data-type='method'><a href="module-Pages_Account.html#~Account">Account</a></li><li data-type='method'><a href="module-Pages_Account.html#~calcAgeFromBirthdate">calcAgeFromBirthdate</a></li><li data-type='method'><a href="module-Pages_Account.html#~pickStr">pickStr</a></li><li data-type='method'><a href="module-Pages_Account.html#~toNum">toNum</a></li></ul></li><li><a href="module-Pages_ForgotPassword.html">Pages/ForgotPassword</a><ul class='methods'><li data-type='method'><a href="module-Pages_ForgotPassword.html#~ForgotPassword">ForgotPassword</a></li></ul></li><li><a href="module-Pages_ResetPassword.html">Pages/ResetPassword</a><ul class='methods'><li data-type='method'><a href="module-Pages_ResetPassword.html#~ResetPassword">ResetPassword</a></li></ul></li><li><a href="module-Pages_SiteMap.html">Pages/SiteMap</a><ul class='methods'><li data-type='method'><a href="module-Pages_SiteMap.html#~SiteMap">SiteMap</a></li></ul></li><li><a href="module-pages_about_About.html">pages/about/About</a><ul class='methods'><li data-type='method'><a href="module-pages_about_About.html#~About">About</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#App">App</a></li><li><a href="global.html#AppRouter">AppRouter</a></li><li><a href="global.html#AppThemeProvider">AppThemeProvider</a></li><li><a href="global.html#AuthCallback">AuthCallback</a></li><li><a href="global.html#Breadcrumbs">Breadcrumbs</a></li><li><a href="global.html#EMAIL_KEY">EMAIL_KEY</a></li><li><a href="global.html#Favorites">Favorites</a></li><li><a href="global.html#FlipCard">FlipCard</a></li><li><a href="global.html#Footer">Footer</a></li><li><a href="global.html#GlobalStyle">GlobalStyle</a></li><li><a href="global.html#Home">Home</a></li><li><a href="global.html#InnerApp">InnerApp</a></li><li><a href="global.html#LABELS">LABELS</a></li><li><a href="global.html#Login">Login</a></li><li><a href="global.html#MOVIE_KEY">MOVIE_KEY</a></li><li><a href="global.html#MovieDetail">MovieDetail</a></li><li><a href="global.html#Movies">Movies</a></li><li><a href="global.html#MoviesPage">MoviesPage</a></li><li><a href="global.html#SkipLink">SkipLink</a></li><li><a href="global.html#Switch">Switch</a></li><li><a href="global.html#TopLoader">TopLoader</a></li><li><a href="global.html#api">api</a></li><li><a href="global.html#authHeaders">authHeaders</a></li><li><a href="global.html#clearToken">clearToken</a></li><li><a href="global.html#darkTheme">darkTheme</a></li><li><a href="global.html#getRandomPexelsVideo">getRandomPexelsVideo</a></li><li><a href="global.html#hasSupabaseAuthParams">hasSupabaseAuthParams</a></li><li><a href="global.html#isAuthed">isAuthed</a></li><li><a href="global.html#isMovieArray">isMovieArray</a></li><li><a href="global.html#lightTheme">lightTheme</a></li><li><a href="global.html#mapNetError">mapNetError</a></li><li><a href="global.html#pathToLabel">pathToLabel</a></li><li><a href="global.html#popFlashToast">popFlashToast</a></li><li><a href="global.html#posterCandidatesFrom">posterCandidatesFrom</a></li><li><a href="global.html#pushFlashToast">pushFlashToast</a></li><li><a href="global.html#request">request</a></li><li><a href="global.html#slugify">slugify</a></li><li><a href="global.html#supa">supa</a></li><li><a href="global.html#themes">themes</a></li><li><a href="global.html#urlJoin">urlJoin</a></li><li><a href="global.html#useDelayedVisible">useDelayedVisible</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">pages/movie/MovieDetail.tsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file MovieDetail.tsx
 * @description Movie detail screen with HTML5 video player, keyboard-accessible
 * controls, and "favorites" toggle. Includes a fallback trailer from Pexels when
 * the movie has no streamUrl. Uses ARIA where appropriate and visible focus styles
 * provided by global CSS.
 *
 * A11y notes:
 * - Buttons and selects are natively focusable (2.1.1 Keyboard).
 * - Focus styles vienen de los estilos globales (2.4.7 Focus Visible).
 * - role="status"/aria-busy/aria-label usados para feedback no intrusivo.
 */

import { useParams, useNavigate, useLocation } from 'react-router-dom'
import { useEffect, useRef, useState } from 'react'
import './MovieDetail.scss'
import { api } from '../../services/api'
import { getRandomPexelsVideo } from '../../services/pexelsServices'
import { Favorites } from '../../services/favorites'
import { getToken } from '../../services/auth'
import { useToast } from '../../components/toast/ToastProvider' // üëà toast

/**
 * Lightweight movie shape used locally in this view.
 */
type Movie = {
  id: string | number
  title: string
  description?: string
  posterUrl?: string
  streamUrl?: string
}

/* ---------- Helpers locales (loader + formato humano) ---------- */

// Barra superior (TopLoader): eventos globales
function loaderStart() {
  window.dispatchEvent(new CustomEvent('top-loader', { detail: 'start' }))
}
function loaderStop() {
  window.dispatchEvent(new CustomEvent('top-loader', { detail: 'stop' }))
}

function formatDateES(d?: string | Date) {
  if (!d) return ''
  const date = typeof d === 'string' ? new Date(d) : d
  if (Number.isNaN(date.getTime())) return ''
  return new Intl.DateTimeFormat('es-CO', { year: 'numeric', month: 'long', day: '2-digit' }).format(date)
}

function formatYearES(d?: string | Date) {
  if (!d) return ''
  const date = typeof d === 'string' ? new Date(d) : d
  return Number.isNaN(date.getTime()) ? '' : String(date.getFullYear())
}

function formatDuration(mins?: number | string) {
  const m = Number(mins)
  if (!Number.isFinite(m) || m &lt;= 0) return ''
  const h = Math.floor(m / 60)
  const r = m % 60
  return h > 0 ? `${h} h ${r} min` : `${r} min`
}

function pickText(m: any, keys: string[]) {
  for (const k of keys) {
    const v = m?.[k]
    if (typeof v === 'string' &amp;&amp; v.trim()) return v.trim()
  }
  return ''
}

/**
 * Movie detail page component.
 * Fetches movie data, wires the &lt;video> element with custom controls,
 * and allows adding/removing the movie from favorites.
 */
/**
 * @component
 * @returns Detailed movie view with trailer playback and favorite toggle.
 */
export default function MovieDetail() {
  // ------- Routing / refs -------
  const { id } = useParams()
  const navigate = useNavigate()
  const location = useLocation()
  const playerRef = useRef&lt;HTMLVideoElement>(null)

  const { error: showErrorToast } = useToast() // üëà toast roja

  // ------- Data / UI state -------
  const [movie, setMovie] = useState&lt;Movie | null>(null)
  const [pexelsVideoUrl, setPexelsVideoUrl] = useState&lt;string | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState&lt;string>()
  const [added, setAdded] = useState(false)
  const [addedMsg, setAddedMsg] = useState('')

  // Favorites state (null while loading)
  const [isFav, setIsFav] = useState&lt;boolean | null>(null)
  const [favBusy, setFavBusy] = useState(false)

  // Player controls state (mirrors &lt;video> props)
  const [playing, setPlaying] = useState(false)
  const [muted, setMuted] = useState(false)
  const [volume, setVolume] = useState(1)
  const [rate, setRate] = useState(1)
  const [loop, setLoop] = useState(false)

  // Sinopsis expand/collapse
  const [synopsisExpanded, setSynopsisExpanded] = useState(false)

  /**
   * Guard against invalid route id.
   */
  useEffect(() => {
    if (!id || id === 'undefined') setError('ID de pel√≠cula inv√°lido')
  }, [id])

  /**
   * Fetch movie by id from backend.
   * Accepts either `{ movie }` or the movie object directly.
   * üîµ Enciende/Apaga TopLoader para visibilidad del estado.
   */
  useEffect(() => {
    if (!id || id === 'undefined') return
      ; (async () => {
        loaderStart()               // ‚¨ÖÔ∏è START loader
        setLoading(true)
        setError(undefined)
        try {
          const resp = await api.get&lt;Movie | { movie: Movie }>(`/movies/${encodeURIComponent(id)}`)
          const m = (resp as any)?.movie ?? resp
          setMovie(m as Movie)
        } catch (e: any) {
          const msg = e?.response?.data?.message || e?.message || 'No se pudo cargar la pel√≠cula'
          setError(msg)
          showErrorToast(msg) // üî¥ toast
        } finally {
          setLoading(false)
          loaderStop()              // ‚¨ÖÔ∏è STOP loader
        }
      })()
  }, [id, showErrorToast])

  /**
   * If no streamUrl in the movie, try finding a relevant stock video on Pexels.
   * Falls back to "cinema" keyword.
   * üîµ Opcional: pulso del loader para la b√∫squeda del trailer.
   */
  useEffect(() => {
    if (!movie?.title || (movie as any).streamUrl) return
    let canceled = false
      ; (async () => {
        loaderStart()               // ‚¨ÖÔ∏è START loader (pulso)
        let url = await getRandomPexelsVideo(movie.title)
        if (!url) url = await getRandomPexelsVideo('cinema')
        if (!canceled) setPexelsVideoUrl(url)
        loaderStop()                // ‚¨ÖÔ∏è STOP loader
      })()
    return () => {
      canceled = true
    }
  }, [movie?.title, (movie as any)?.streamUrl])

  /**
   * Sync local "playing" state by listening to native &lt;video> events.
   */
  useEffect(() => {
    const v = playerRef.current
    if (!v) return
    const onPlay = () => setPlaying(true)
    const onPause = () => setPlaying(false)
    v.addEventListener('play', onPlay)
    v.addEventListener('pause', onPause)
    return () => {
      v.removeEventListener('play', onPlay)
      v.removeEventListener('pause', onPause)
    }
  }, [])

  /**
   * Apply local controls state to the underlying &lt;video> element.
   */
  useEffect(() => {
    const v = playerRef.current
    if (!v) return
    v.muted = muted
    v.volume = volume
    v.playbackRate = rate
    v.loop = loop
  }, [muted, volume, rate, loop])

  // ------- Hotkeys (no intrusivo) -------
  // Espacio/K (play/pausa), J/L (‚àí/+10s), M (mute), F (fullscreen), P (PiP)
  useEffect(() => {
    const isEditable = (el: EventTarget | null) => {
      const n = el as HTMLElement | null
      if (!n) return false
      const tag = (n.tagName || '').toLowerCase()
      const editable = (n.getAttribute?.('contenteditable') || '').toLowerCase()
      return tag === 'input' || tag === 'textarea' || editable === 'true'
    }

    function onKey(e: KeyboardEvent) {
      if (e.altKey || e.ctrlKey || e.metaKey || isEditable(e.target)) return
      const key = e.key.toLowerCase()
      if (e.key === ' ' || key === 'k') {
        e.preventDefault()
        togglePlay()
      } else if (key === 'j') {
        seek(-10)
      } else if (key === 'l') {
        seek(10)
      } else if (key === 'm') {
        toggleMute()
      } else if (key === 'f') {
        toggleFullscreen()
      } else if (key === 'p') {
        togglePiP()
      }
    }
    window.addEventListener('keydown', onKey)
    return () => window.removeEventListener('keydown', onKey)
  }, [])

  // ------- Player helpers -------

  /** Play/pause the video depending on current state. */
  function togglePlay() {
    const v = playerRef.current
    if (!v) return
    if (v.paused) v.play()
    else v.pause()
  }

  /**
   * Seek the video by an offset in seconds (negative or positive).
   * Clamps the target time to [0, duration].
   * @param offset seconds to jump
   */
  function seek(offset: number) {
    const v = playerRef.current
    if (!v) return
    const d = v.duration || Infinity
    v.currentTime = Math.max(0, Math.min(d, v.currentTime + offset))
  }

  /** Mute/unmute shortcut. */
  function toggleMute() {
    setMuted(m => !m)
  }

  /**
   * Volume range input handler (0..1).
   * Also auto-unmutes when user sets volume > 0 while muted.
   */
  function onVolume(e: React.ChangeEvent&lt;HTMLInputElement>) {
    const val = Number(e.target.value)
    setVolume(val)
    if (val > 0 &amp;&amp; muted) setMuted(false)
  }

  /** Playback rate (speed) select handler. */
  function onRate(e: React.ChangeEvent&lt;HTMLSelectElement>) {
    setRate(Number(e.target.value))
  }

  /** Toggle loop mode. */
  function toggleLoop() {
    setLoop(l => !l)
  }

  /**
   * Toggle Picture-in-Picture when supported.
   * Silently catches failures (e.e., browser policies).
   */
  async function togglePiP() {
    const v = playerRef.current as any
    try {
      if ('pictureInPictureElement' in document &amp;&amp; (document as any).pictureInPictureElement) {
        await (document as any).exitPictureInPicture()
      } else if (v?.requestPictureInPicture) {
        await v.requestPictureInPicture()
      }
    } catch (e) {
      console.error('PiP error', e)
    }
  }

  /** Toggle native fullscreen for the &lt;video> element. */
  async function toggleFullscreen() {
    const v = playerRef.current
    if (!v) return
    try {
      if (document.fullscreenElement) {
        await document.exitFullscreen()
      } else {
        await v.requestFullscreen?.()
      }
    } catch (e) {
      console.error('Fullscreen error', e)
    }
  }

  // ------- Favorites -------

  /**
   * Initialize favorites state for the current movie.
   * If user is not authenticated, default to false.
   */
  useEffect(() => {
    const movieId = String((movie?.id ?? (movie as any)?._id ?? (movie as any)?.uuid ?? id) ?? '')
    if (!movieId) {
      setIsFav(false)
      return
    }
    if (!getToken()) {
      setIsFav(false)
      return
    }

    let alive = true
      ; (async () => {
        try {
          const exists = await Favorites.has(movieId)
          if (alive) setIsFav(!!exists)
        } catch {
          if (alive) setIsFav(false)
        }
      })()
    return () => {
      alive = false
    }
  }, [movie, id])

  /**
   * Toggle favorites on/off for the current movie.
   * - If unauthenticated, redirects to /login with "next" param.
   * - Shows non-blocking status text after the operation.
   */
  async function toggleFav() {
    const movieId = String((movie?.id ?? (movie as any)?._id ?? (movie as any)?.uuid ?? id) ?? '')
    if (!movieId || favBusy || isFav === null) return

    if (!getToken()) {
      navigate(`/login?next=${encodeURIComponent(location.pathname + location.search)}`)
      return
    }

    setFavBusy(true)
    try {
      if (isFav) {
        await Favorites.remove(movieId)
        setIsFav(false)
        setAddedMsg('Quitada de favoritos')
      } else {
        await Favorites.add(movieId)
        setIsFav(true)
        setAddedMsg('A√±adida a favoritos')
      }
      setAdded(true)
      setTimeout(() => setAdded(false), 2200)
    } catch (e: any) {
      const msg =
        e?.response?.data?.error?.message ||
        e?.response?.data?.message ||
        e?.message ||
        'No se pudo actualizar tus favoritos'
      showErrorToast(msg) // üî¥ toast
    } finally {
      setFavBusy(false)
    }
  }

  // ------- Render guards -------

  if (loading) {
    return (
      &lt;section className="container">
        {/* aria-busy hints async load to AT users */}
        &lt;p aria-busy="true">Cargando‚Ä¶&lt;/p>
      &lt;/section>
    )
  }
  if (error) {
    return (
      &lt;section className="container">
        {/* role="alert" announces error messages immediately */}
        &lt;p role="alert" style={{ color: 'salmon' }}>{error}&lt;/p>
      &lt;/section>
    )
  }
  if (!movie) return null

  // Prefer backend stream, otherwise Pexels fallback (or undefined)
  const videoSrc = (movie as any).streamUrl || pexelsVideoUrl || undefined

  // ---------- Meta ‚Äúhumana‚Äù (estreno/duraci√≥n/g√©neros) ----------
  // Fallback: si no hay release_date, usamos year de la DB.
  const rawRelease = (movie as any)?.release_date ?? (movie as any)?.releaseDate
  const yearField = (movie as any)?.year
  const year = formatYearES(rawRelease) || (yearField ? String(yearField) : '')
  const estreno = formatDateES(rawRelease) || (year ? year : '')
  const duracion = formatDuration((movie as any)?.runtime ?? (movie as any)?.duration)
  const genres = Array.isArray((movie as any)?.genres)
    ? ((movie as any).genres as any[]).map(g => (typeof g === 'string' ? g : g?.name)).filter(Boolean)
    : []

  // ---------- Sinopsis con fallback + ‚Äúver m√°s/menos‚Äù ----------
  const rawSynopsis =
    pickText(movie, ['description', 'overview', 'synopsis', 'plot', 'summary']) || (movie as any)?.description || ''
  const hasSynopsis = !!rawSynopsis
  const maxChars = 280
  const shortText = hasSynopsis &amp;&amp; rawSynopsis.length > maxChars ? rawSynopsis.slice(0, maxChars) + '‚Ä¶' : rawSynopsis

  return (
    &lt;section className="container movie-detail movie-detail--single">
      &lt;h1 className="detail-title">{movie.title}&lt;/h1>

      &lt;div className={`player ${!videoSrc ? 'is-loading' : ''}`}>
        &lt;video
          ref={playerRef}
          id="player"
          controls
          poster={(movie as any).posterUrl}
          src={videoSrc}
          style={{ width: '100%', maxWidth: 980, borderRadius: 8 }}
        />

        {/* Toolbar: all buttons are keyboard accessible (2.1.1) */}
        &lt;div className="toolbar" aria-label="Controles de reproducci√≥n">
          &lt;div className="group">
            &lt;button
              type="button"
              className="ctrl hit-24"
              onClick={togglePlay}
              aria-pressed={playing}
              disabled={!videoSrc}
            >
              {playing ? '‚è∏ Pausa' : '‚ñ∂ Reproducir'}
            &lt;/button>

            &lt;button type="button" className="ctrl hit-24" onClick={() => seek(-10)} disabled={!videoSrc}>
              ‚èÆ 10s
            &lt;/button>
            &lt;button type="button" className="ctrl hit-24" onClick={() => seek(10)} disabled={!videoSrc}>
              10s ‚è≠
            &lt;/button>
          &lt;/div>

          &lt;div className="group volume">
            &lt;button type="button" className="ctrl hit-24" onClick={toggleMute} aria-pressed={muted} disabled={!videoSrc}>
              {muted || volume === 0 ? 'üîá Mute' : 'üîä Volumen'}
            &lt;/button>
            &lt;input
              className="range"
              type="range"
              min={0}
              max={1}
              step={0.01}
              value={volume}
              onChange={onVolume}
              disabled={!videoSrc}
              aria-label="Ajustar volumen"
            />
          &lt;/div>

          &lt;div className="spacer" />

          &lt;div className="group rate">
            &lt;span style={{ opacity: 0.8 }}>Vel:&lt;/span>
            &lt;select value={rate} onChange={onRate} disabled={!videoSrc} aria-label="Velocidad de reproducci√≥n">
              &lt;option value={0.5}>0.5√ó&lt;/option>
              &lt;option value={0.75}>0.75√ó&lt;/option>
              &lt;option value={1}>1√ó&lt;/option>
              &lt;option value={1.25}>1.25√ó&lt;/option>
              &lt;option value={1.5}>1.5√ó&lt;/option>
              &lt;option value={2}>2√ó&lt;/option>
            &lt;/select>
          &lt;/div>

          &lt;div className="group">
            &lt;button type="button" className="ctrl hit-24" onClick={toggleLoop} aria-pressed={loop} disabled={!videoSrc}>
              {loop ? 'üîÅ Loop ON' : 'Loop OFF'}
            &lt;/button>
            &lt;button type="button" className="ctrl hit-24" onClick={togglePiP} disabled={!videoSrc}>
              üóî PiP
            &lt;/button>
            &lt;button type="button" className="ctrl hit-24" onClick={toggleFullscreen} disabled={!videoSrc}>
              ‚õ∂ Full
            &lt;/button>
          &lt;/div>
        &lt;/div>

        &lt;div className="actions actions--video">
          &lt;button className="btn primary" onClick={toggleFav} disabled={favBusy || isFav === null} aria-pressed={!!isFav}>
            {favBusy ? 'Guardando‚Ä¶' : isFav ? 'Quitar de favoritos' : 'A√±adir a favoritos'}
          &lt;/button>
        &lt;/div>
        {/* role="status" announces transient confirmation text */}
        {added &amp;&amp; &lt;p role="status" className="muted">{addedMsg}&lt;/p>}
      &lt;/div>

      {/* ---- Detalles ---- */}
      {(estreno || duracion || genres.length) &amp;&amp; (
        &lt;section className="movie-meta" aria-labelledby="meta-title">
          &lt;h2 id="meta-title">Detalles&lt;/h2>
          &lt;ul className="meta-list">
            {estreno &amp;&amp; &lt;li>&lt;strong>Estreno:&lt;/strong> {estreno}{year ? ` (${year})` : ''}&lt;/li>}
            {duracion &amp;&amp; &lt;li>&lt;strong>Duraci√≥n:&lt;/strong> {duracion}&lt;/li>}
            {!!genres.length &amp;&amp; &lt;li>&lt;strong>G√©neros:&lt;/strong> {genres.join(', ')}&lt;/li>}
          &lt;/ul>
        &lt;/section>
      )}

      {/* ---- SINOPSIS (texto legible con ‚Äúver m√°s/menos‚Äù) ---- */}
      &lt;section className="movie-synopsis" aria-labelledby="syn-title">
        &lt;h2 id="syn-title">Sinopsis&lt;/h2>
        &lt;p id="synopsis-text" style={{ whiteSpace: 'pre-line' }}>
          {hasSynopsis ? (synopsisExpanded ? rawSynopsis : shortText) : 'No hay sinopsis disponible por ahora.'}
        &lt;/p>

        {hasSynopsis &amp;&amp; rawSynopsis.length > maxChars &amp;&amp; (
          &lt;button
            type="button"
            className="linklike"
            aria-expanded={synopsisExpanded}
            aria-controls="synopsis-text"
            onClick={() => setSynopsisExpanded(v => !v)}
          >
            {synopsisExpanded ? 'Ver menos' : 'Ver m√°s'}
          &lt;/button>
        )}
      &lt;/section>
    &lt;/section>
  )
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Fri Oct 31 2025 00:48:56 GMT-0500 (hora est√°ndar de Colombia) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
